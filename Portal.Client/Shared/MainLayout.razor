@using System.Text.Json
@using Portal.Shared.DTO.Setting
@using Toolbelt.Blazor.HotKeys2
@implements IAsyncDisposable
@inherits LayoutComponentBase
@inject HotKeys _hotKeys

<div class="page">
    <SideNav ToggleNav=ToggleNav Hide="@ToggleNav" NavLinks="navLinks" />
    <div class="top-row @(headerVisible ? "header-visible" : "header-hidden")">
        <NavBar ShowNav="hideSidebar" ToggleNav=ToggleNav />
    </div>
    @* <QuickSearch /> *@
    <div class="@MainClass">
        @Body
    </div>
    @* <footer>
        Built by <a href="https://webres.solutions" target="_blank" style="color: #b2424d;">Webres Solutions</a>
    </footer> *@
</div>

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider MaxWidth="MaxWidth.Large" />
<MudSnackbarProvider />

@code {
    protected HotKeysContext? _hotKeysContext;
    private readonly DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    private bool hideSidebar = false;
    private bool headerVisible = true;

    private List<NavLinkItem> navLinks = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        string today = DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd");
        navLinks = new List<NavLinkItem>
        {
            new NavLinkItem { Link = "", Title = "Home", Icon = Icons.Material.Filled.Home, MatchAll = true },
            new NavLinkItem { Link = "Jobs", Title = "Jobs", Icon = Icons.Material.Filled.PanTool },
            new NavLinkItem { Link = "Quotes", Title = "Quotes", Icon = Icons.Material.Filled.Numbers },
            new NavLinkItem { Link = "Contacts", Title = "Contacts", Icon = Icons.Material.Filled.People },
            new NavLinkItem { Link = "Councils", Title = "Councils", Icon = Icons.Material.Filled.Home },
            new NavLinkItem
            {
                Link = "Schedule",
                Title = "Schedule",
                Icon = Icons.Material.Filled.CalendarViewMonth,
                SubLinks = new List<NavLinkItem>
                {
                    new NavLinkItem { Link = $"Schedule/{today}/1", Title = "Construction", Icon = Icons.Material.Filled.Build },
                    new NavLinkItem { Link = $"Schedule/{today}/2", Title = "Surveying", Icon = Icons.Material.Filled.Map }
                }
            },
            new NavLinkItem { Link = "Settings", Title = "Settings", Icon = Icons.Material.Filled.Settings }
        };
    }

    private void ToggleNav() => hideSidebar = !hideSidebar;

    private string MainClass => hideSidebar ? "main full" : "main";

    private string FullWidth => hideSidebar ? "full" : "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _hotKeysContext = _hotKeys.CreateContext()
                .Add(ModCode.Ctrl | ModCode.Shift, Code.ArrowUp, () => GoToNextNavItem(true), new HotKeyOptions() { Description = "Navigate to the next page up" })
                .Add(ModCode.Ctrl | ModCode.Shift, Code.ArrowDown, () => GoToNextNavItem(false), new HotKeyOptions() { Description = "Navigate to the next page down" })
                .Add(ModCode.Ctrl | ModCode.Shift, Code.S, OpenDialogAsync, new HotKeyOptions() { Description = "Opens the quick search for jobs" });
            await _jsRuntime.InvokeVoidAsync("initializeScrollHeader");
            await LoadThemeSettings();
        }
    }

    private Task OpenDialogAsync()
    {
        return _dialog.ShowAsync<SearchDialog>("", new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true });
    }

    public async ValueTask DisposeAsync()
    {
        if (_hotKeysContext != null)
            await _hotKeysContext.DisposeAsync();
    }

    private void GoToNextNavItem(bool up)
    {
        // find the current nav item. Remove any query strings and trailing slashes
        string uri = _navigationManager.ToBaseRelativePath(_navigationManager.Uri).TrimEnd('/').Split('?')[0];
        if (uri.Contains('/'))
            uri = uri.Split('/')[0];

        // Find the index of the current nav item
        int currentIndex = navLinks?.FindIndex(n => n.Link.Equals(uri, StringComparison.OrdinalIgnoreCase)) ?? -1;

        if (up)
            currentIndex--;
        else
            currentIndex++;

        // Loop around: wrap to end if going before start, wrap to start if going past end
        if (currentIndex < 0)
            currentIndex = navLinks!.Count - 1;
        else if (currentIndex >= navLinks!.Count)
            currentIndex = 0;

        NavLinkItem newNavItem = navLinks[currentIndex];

        if (newNavItem.DoAction is not null)
            newNavItem.DoAction.Invoke();
        else if (newNavItem.Link is not null)
            _navigationManager.NavigateTo(newNavItem.Link);

    }


    private async Task LoadThemeSettings()
    {
        // Try to load from session storage first (faster, no API call)
        ThemeSettingsDto? sessionSettings = _sessionStorage.GetItem<ThemeSettingsDto>("SystemSettings");

        if (sessionSettings is not null &&
            !string.IsNullOrWhiteSpace(sessionSettings.PrimaryColour) &&
            !string.IsNullOrWhiteSpace(sessionSettings.SecondaryColour))
        {
            await Helpers.SetColour(_jsRuntime, sessionSettings.PrimaryColour, true);
            await Helpers.SetColour(_jsRuntime, sessionSettings.SecondaryColour, false);
            return;
        }

        // Fallback to API if session storage is empty or invalid
        Result<SystemSettingDto> appsettings = await _apiService.GetSystemSettings();

        if (appsettings.Error is not null || appsettings.Value is null)
            return;

        if (string.IsNullOrWhiteSpace(appsettings.Value.SettingJson))
            return;

        try
        {
            ThemeSettingsDto? settings = JsonSerializer.Deserialize<ThemeSettingsDto>(appsettings.Value.SettingJson);

            if (settings is null ||
                string.IsNullOrWhiteSpace(settings.PrimaryColour) ||
                string.IsNullOrWhiteSpace(settings.SecondaryColour))
                return;

            // Save to session storage for next time
            _sessionStorage.SetItem("SystemSettings", settings);

            // Apply the colors
            await Helpers.SetColour(_jsRuntime, settings.PrimaryColour, true);
            await Helpers.SetColour(_jsRuntime, settings.SecondaryColour, false);
        }
        catch (JsonException)
        {
            // Invalid JSON, skip setting colors
        }
    }
}
