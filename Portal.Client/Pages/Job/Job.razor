@page "/jobs/{JobId:int}"
@inherits BaseDataComponent
@using Portal.Shared
@using Portal.Shared.DTO.Job
@using Portal.Shared.DTO.Address
@using Portal.Shared.Helpers

<PageTitle>Job @(_job?.JobNumber ?? JobId) - PRS Portal</PageTitle>

@if (IsLoading)
{
    <div class="container">
        <div class="loading-spinner">Loading...</div>
    </div>
}
else if (_job is null)
{
    <div class="container">
        <div class="error-message">Job not found</div>
    </div>
}
else
{
    <div class="job-detail-container">
        <!-- Header -->
        <div class="job-header">
            <div class="header-left">
                <h1>Job #@_job.JobId</h1>
                <div class="header-info">
                    <span style="color: var(--colour-primary)">Job #@_job.JobNumber</span>
                    <span>•</span>
                    <span>@GetAddressString()</span>
                </div>
            </div>
            <div class="header-right">
                <StatusBadge statusEnum="@_job.JobType" />
                <div class="header-actions">
                    <button class="btn-icon" title="Edit">✏️</button>
                    <button class="btn-icon" title="Lock">🔒</button>
                    <button class="btn-icon" title="Print">🖨️</button>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <!-- Quick Stats -->
                <Card Title="Overview">
                    <ChildContent>
                        <div class="stats-mini">
                            <div class="stat-mini">
                                <div class="stat-mini-value">@_dummyData.TasksCount</div>
                                <div class="stat-mini-label">Tasks</div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-mini-value">@_dummyData.InvoicesCount</div>
                                <div class="stat-mini-label">Invoices</div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-mini-value">@(_job.Notes?.Count ?? 0)</div>
                                <div class="stat-mini-label">Notes</div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-mini-value">@_dummyData.ContactsCount</div>
                                <div class="stat-mini-label">Contacts</div>
                            </div>
                        </div>
                    </ChildContent>
                </Card>

                <!-- Job Info -->
                <Card Title="Job Information">
                    <ChildContent>
                        <div class="info-list">
                            <div class="info-row">
                                <span class="info-label">Contact</span>
                                <span class="info-value">@_dummyData.ContactName</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone</span>
                                <span class="info-value">@_dummyData.Phone</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Council</span>
                                <span class="info-value">@_dummyData.Council</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Plan Ref</span>
                                <span class="info-value">@_dummyData.PlanRef</span>
                            </div>
                        </div>
                    </ChildContent>
                </Card>

                <!-- Quick Actions -->
                <Card Title="Quick Actions">
                    <ChildContent>
                        <div class="quick-actions">
                            <button class="quick-action-btn">+ Add Technical Contact</button>
                            <button class="quick-action-btn">+ Add Task</button>
                            <button class="quick-action-btn">+ Add Invoice</button>
                            <button class="quick-action-btn">+ Add Site Visit</button>
                            <button class="quick-action-btn">+ Add Note</button>
                        </div>
                    </ChildContent>
                </Card>
            </div>


            <!-- Right Sidebar -->
            <div class="sidebar">
                <!-- Site Visits -->
                <JobSiteVisits SiteVisits="_job.SiteVisits" OnAdd="HandleAddSiteVisit" />

                <!-- Notes -->
                <JobNotes Notes="@(_job.Notes ?? new List<JobNoteDto>())" OnAdd="HandleAddNote" />
            </div>
            <!-- Main Content -->
            <div class="content-area">
                <!-- Technical Contacts -->
                <Card>
                    <TitleContent>
                        <div class="card-header-with-tabs">
                            <div class="tabs">
                                <button class="tab active">All</button>
                                <button class="tab">Deleted</button>
                            </div>
                            <button class="btn-add">+ Add</button>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Role</th>
                                    <th>Contact</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (_dummyData.TechnicalContacts.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" class="empty-state">No records</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var contact in _dummyData.TechnicalContacts)
                                    {
                                        <tr>
                                            <td>@contact.Role</td>
                                            <td>@contact.Name</td>
                                            <td>@contact.Phone</td>
                                            <td>@contact.Email</td>
                                            <td>
                                                <button class="btn-icon-small">✏️</button>
                                                <button class="btn-icon-small">🗑️</button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </ChildContent>
                </Card>

                <!-- Tasks -->
                <Card>
                    <TitleContent>
                        <div class="card-header-with-tabs">
                            <div class="tabs">
                                <button class="tab active">All</button>
                                <button class="tab">Active</button>
                                <button class="tab">To Invoice</button>
                                <button class="tab">Deleted</button>
                            </div>
                            <button class="btn-add">+ Add</button>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Quoted Price</th>
                                    <th>Active Date</th>
                                    <th>Completed Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (_dummyData.Tasks.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" class="empty-state">No records</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var task in _dummyData.Tasks)
                                    {
                                        <tr>
                                            <td>@task.Name</td>
                                            <td>@task.QuotedPrice</td>
                                            <td>@task.ActiveDate</td>
                                            <td>@task.CompletedDate</td>
                                            <td>
                                                <button class="btn-icon-small">✏️</button>
                                                <button class="btn-icon-small">🗑️</button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </ChildContent>
                </Card>

                <!-- Invoices -->
                <Card>
                    <TitleContent>
                        <div class="card-header-with-tabs">
                            <div class="tabs">
                                <button class="tab active">All</button>
                                <button class="tab">Unsent</button>
                                <button class="tab">Unpaid</button>
                                <button class="tab">Overdue</button>
                            </div>
                            <button class="btn-add">+ Add</button>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Number</th>
                                    <th>Contact</th>
                                    <th>Total Price</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (_dummyData.Invoices.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" class="empty-state">No records</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var invoice in _dummyData.Invoices)
                                    {
                                        <tr>
                                            <td>@invoice.Number</td>
                                            <td>@invoice.Contact</td>
                                            <td>@invoice.TotalPrice</td>
                                            <td>@invoice.CreatedDate</td>
                                            <td>
                                                <button class="btn-icon-small">✏️</button>
                                                <button class="btn-icon-small">🗑️</button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </ChildContent>
                </Card>

                <!-- Checklist -->
                <Card Title="Checklist">
                    <ChildContent>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Site Work</th>
                                    <th>Checked</th>
                                    <th>Sent</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _dummyData.ChecklistItems)
                                {
                                    <tr>
                                        <td>@item.Name</td>
                                        <td>
                                            <select class="select-small">
                                                <option>Not Completed</option>
                                                <option>Completed</option>
                                            </select>
                                        </td>
                                        <td><input type="checkbox" checked="@item.Checked" /></td>
                                        <td><input type="checkbox" checked="@item.Sent" /></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </ChildContent>
                </Card>

                <!-- Recent Activity -->
                <Card Title="Activity">
                    <ChildContent>
                        <div class="activity-list">
                            @foreach (var activity in _dummyData.Activities)
                            {
                                <div class="activity-item">
                                    <div class="activity-title">@activity.Title</div>
                                    <div class="activity-time">@activity.Time</div>
                                </div>
                            }
                        </div>
                    </ChildContent>
                </Card>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public required int JobId { get; set; }

    private JobDetailsDto? _job;
    private DummyJobData _dummyData = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadJobData();
    }

    private async Task LoadJobData()
    {
        IsLoading = true;
        try
        {
            Result<JobDetailsDto>? result = await _apiService.Job(JobId);
            if (result is not null && result.IsSuccess && result.Value is not null)
            {
                _job = result.Value;
            }
            else
            {
                if (_snackbar is not null)
                    _snackbar.Add("Error loading job details", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            if (_snackbar is not null)
                _snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetAddressString()
    {
        if (_job?.Address is null)
            return "No address";
        
        return $"{_job.Address.suburb.ToUpper()}, {_job.Address.State} {_job.Address.postCode}";
    }

    private Task HandleAddNote()
    {
        // TODO: Implement add note functionality
        return Task.CompletedTask;
    }

    private Task HandleAddSiteVisit()
    {
        // TODO: Implement add site visit functionality
        return Task.CompletedTask;
    }

    private class DummyJobData
    {
        public int TasksCount { get; set; } = 0;
        public int InvoicesCount { get; set; } = 0;
        public int ContactsCount { get; set; } = 0;
        public string ContactName { get; set; } = "ALL HOMES / PERRY";
        public string Phone { get; set; } = "018 368 142";
        public string Council { get; set; } = "SHIRE OF MACEDON RANGES";
        public string PlanRef { get; set; } = "LP1727490";
        
        public List<TechnicalContact> TechnicalContacts { get; set; } = new();
        public List<TaskItem> Tasks { get; set; } = new();
        public List<InvoiceItem> Invoices { get; set; } = new();
        public List<ChecklistItem> ChecklistItems { get; set; } = new()
        {
            new ChecklistItem { Name = "RE Survey", Checked = false, Sent = false },
            new ChecklistItem { Name = "Feature Plan", Checked = false, Sent = false },
            new ChecklistItem { Name = "MGA", Checked = false, Sent = false }
        };
        public List<SiteVisit> SiteVisits { get; set; } = new();
        public List<ActivityItem> Activities { get; set; } = new()
        {
            new ActivityItem { Title = "Note Added", Time = "2 hours ago" },
            new ActivityItem { Title = "Job Modified", Time = "Yesterday" }
        };
    }

    private class TechnicalContact
    {
        public string Role { get; set; } = "";
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Email { get; set; } = "";
    }

    private class TaskItem
    {
        public string Name { get; set; } = "";
        public string QuotedPrice { get; set; } = "";
        public string ActiveDate { get; set; } = "";
        public string CompletedDate { get; set; } = "";
    }

    private class InvoiceItem
    {
        public string Number { get; set; } = "";
        public string Contact { get; set; } = "";
        public string TotalPrice { get; set; } = "";
        public string CreatedDate { get; set; } = "";
    }

    private class ChecklistItem
    {
        public string Name { get; set; } = "";
        public bool Checked { get; set; }
        public bool Sent { get; set; }
    }

    private class SiteVisit
    {
        public string Date { get; set; } = "";
        public string Details { get; set; } = "";
    }

    private class ActivityItem
    {
        public string Title { get; set; } = "";
        public string Time { get; set; } = "";
    }
}
