@page "/jobs"
@using Portal.Shared
@using Portal.Shared.DTO.Job
@using Portal.Shared.ResponseModels
@using Portal.Shared.Web
@inherits BaseDataComponent;

<Card Title="Jobs">
    <ChildContent>
        <MudDataGrid T="ListJobDto"
                     ServerData="LoadJobs"
                     Filterable="true"
                     SortMode="SortMode.Single"
                     Loading="base.IsLoading"
                     RowsPerPage="_rowsPerPage"
                     RowsPerPageValues="@(new int[] { 10, 25, 50, 100 })"
                     CurrentPage="_sessionData.Page"
                     CurrentPageChanged="@((page) => _sessionData.Page = page)"
                     Dense=true
                     @ref="_grid">
            <ToolBarContent>
                <MudTextField T="string" @bind-Value="_sessionData.SearchString" Placeholder="Search" Adornment="Adornment.Start" TextChanged="(async (x) => await OnSearch(x))"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Clearable="true" OnClearButtonClick="ClearSearch"></MudTextField>
            </ToolBarContent>
            <Columns>
              
                <PropertyColumn Property="x => x.Contact" ShowFilterIcon="false" />
                <PropertyColumn Property="x => x.Address.street" ShowFilterIcon="false" Title="Street" />
                <PropertyColumn Property="x => x.Address.suburb" ShowFilterIcon="false" Title="Suburb" />
                <PropertyColumn Property="x => x.ConstructionNumber" ShowFilterIcon="false" Title="Construction Number"/>
                <PropertyColumn Property="x => x.SurveyNumber" ShowFilterIcon="false" Title="Survey Number" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="ListJobDto" />
            </PagerContent>
        </MudDataGrid>
    </ChildContent>
</Card>

@code {
    private PagedResponse<ListJobDto>? _pagedResponse;
    private readonly int _rowsPerPage = 25;
    private MudDataGrid<ListJobDto>? _grid;
     /// <summary>
    /// Session data for the facilities page
    /// </summary>
    private SessionSearchData _sessionData = new();

    #region Constants
    private const string _FacilitiesSessionKey = "FacilitiesSession";
    #endregion

    /// <summary>
    /// Called when the component is initialized.
    /// Data loading for the grid is now handled by LoadFacilitiesServerData.
    /// </summary>
    /// <returns>A task representing the asynchronous operation</returns>
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Restore session data
        SessionSearchData? savedSession = _sessionStorage.GetItem<SessionSearchData>(_FacilitiesSessionKey);
        if (savedSession is not null)
            _sessionData = savedSession;
    }

    /// <summary>
    /// Saves the current session data to session storage
    /// </summary>
    private void SaveSessionData() => _sessionStorage.SetItem(_FacilitiesSessionKey, _sessionData);

    /// <summary>
    /// This method is called by the MudDataGrid to fetch data when needed (paging, sorting, filtering).
    /// Implements server-side data loading with pagination and search capabilities.
    /// </summary>
    /// <param name="state">The current grid state containing pagination and sorting information</param>
    /// <returns>A GridData object containing the current page of facilities and total count</returns>
    private async Task<GridData<ListJobDto>> LoadJobs(GridState<ListJobDto> state)
    {
        IsLoading = true;

        try
        {
            int apiPageNumber = state.Page;
            int apiPageSize = state.PageSize;
            apiPageNumber++;

            // Handle sorting from grid state
            SortDefinition<ListJobDto>? sortDefinition = state.SortDefinitions.FirstOrDefault();
            if (sortDefinition != null)
            {
                // Set order direction
                _sessionData.Order = sortDefinition.Descending ? SortDirectionEnum.Desc : SortDirectionEnum.Asc;

                // Map the property name to the API's expected orderby value
                _sessionData.OrderBy = sortDefinition.SortBy switch
                {
                    nameof(ListJobDto.Contact) or
                    nameof(ListJobDto.Address.street) or
                    nameof(ListJobDto.Address.suburb) or
                    nameof(ListJobDto.SurveyNumber) or
                    nameof(ListJobDto.ConstructionNumber) or
                    _ => nameof(ListJobDto.Contact) // Default
                };
            }
            else
            {
                // Default sorting if no sort definition
                _sessionData.OrderBy = nameof(ListJobDto.JobId);
                _sessionData.Order = SortDirectionEnum.Asc;
            }

            // Save current state to session
            _sessionData.Page = state.Page;
            _sessionData.PageSize = state.PageSize;
            _sessionData.PageSize = state.PageSize;
            SaveSessionData();

            Result<PagedResponse<ListJobDto>>? apiResult = await _apiService.GetAllJobs(
                apiPageSize,
                apiPageNumber,
                _sessionData.SearchString,
                _sessionData.OrderBy,
                _sessionData.Order);

            if (apiResult is not null && apiResult.IsSuccess && apiResult.Value is not null)
            {
                _pagedResponse = apiResult.Value;
                // MudDataGrid requires GridData with Items for the current page and TotalItems count
                return new GridData<ListJobDto>()
                {
                    Items = _pagedResponse.Result ?? Enumerable.Empty<ListJobDto>(),
                    TotalItems = _pagedResponse.TotalCount
                };
            }
            else
            {
                // Handle API error or unsuccessful result
                string errorMessage = "Failed to load facilities data from the API.";
                Console.WriteLine($"API Error: {errorMessage}");
                if (_dialogService is not null)
                {
                    _ = await _dialogService.ShowMessageBox("Error", errorMessage);
                }
                return new GridData<ListJobDto>() { Items = [], TotalItems = 0 };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Unexpected Error: {ex.Message}");
            if (_dialogService != null)
            {
                _ = await _dialogService.ShowMessageBox("Error", "An unexpected error occurred while fetching facilities.");
            }
            return new GridData<ListJobDto>() { Items = Enumerable.Empty<ListJobDto>(), TotalItems = 0 };
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Manually refreshes the grid's data from another action (e.g., after adding/editing a facility)
    /// </summary>
    /// <returns>A task representing the asynchronous operation</returns>
    public async Task RefreshGridData()
    {
        if (_grid is not null)
            await _grid.ReloadServerData();
    }

    /// <summary>
    /// Handles search input changes and triggers grid data reload with the new search criteria
    /// </summary>
    /// <param name="text">The search text entered by the user</param>
    /// <returns>A task representing the asynchronous operation</returns>
    private Task OnSearch(string text)
    {
        _sessionData.SearchString = text;
        // Reset to first page when search changes
        _sessionData.Page = 0;
        SaveSessionData();
        return _grid!.ReloadServerData();
    }

    private Task ClearSearch()
    {
        _sessionData.SearchString = string.Empty;
        _sessionData.Page = 0;
        _sessionStorage.RemoveItem(_FacilitiesSessionKey);
        _sessionData = new SessionSearchData(); // Reset to defaults
        return _grid!.ReloadServerData();
    }

    /// <summary>
    /// Handles marker click navigation to job page
    /// </summary>
    /// <param name="facilityId">The facility ID to navigate to</param>
    private Task NavigateToFacility(int facilityId)
    {
        _navigationManager.NavigateTo($"/Jobs/{facilityId}");
        return Task.CompletedTask;
    }
}