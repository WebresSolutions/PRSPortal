
<nav class="sidebar d-flex ps-2 gap-2 flex-column shadow" style="background-color: var(--color-white)">
    <NavLink href="/">
        <img alt="PRS" src=@(Minimize ? "/images/MinimalLogo.svg" : "/images/PRS-Primary-Logo.svg")
             style=@(Minimize ? "width: 40px" : "width:120px") class="prs-logo ms-2" />
    </NavLink>
    <button @onclick="@(MinimizeSidebar)" class="nav-hide-button"><i class=@(!Minimize ? "bi bi-arrow-left-circle" : "bi bi-arrow-right-circle")></i></button>
    <AuthorizeView>
        <ul class="nav flex-column mt-3">
            @foreach (NavLinkItem navItem in NavLinks)
            {
                <li class="nav-item px-1 @(Minimize ? "min" : "")">
                    <div class="nav-link-container">
                        <NavLink class="nav-link" href="@(navItem.Link is null ? null : navItem.Link)" Match="@(navItem.MatchAll? NavLinkMatch.All: NavLinkMatch.Prefix)">
                            <MudIcon Icon="@navItem.Icon" Title="@navItem.Title" />
                            @if (!Minimize)
                            {
                                <span class="nav-link-text">@navItem.Title</span>
                            }
                        </NavLink>
                        @if (navItem.SubLinks.Count > 0 && !Minimize)
                        {
                            <i class="@(expandedItems.ContainsKey(navItem) && expandedItems[navItem] ? "bi bi-chevron-up" : "bi bi-chevron-down") nav-chevron"
                               role="button"
                               @onclick="@(() => ToggleSubLinks(navItem))"
                               title="@(expandedItems.ContainsKey(navItem) && expandedItems[navItem] ? "Collapse" : "Expand")"></i>
                        }
                    </div>
                </li>
                @if (!Minimize && navItem.SubLinks.Count > 0 && expandedItems.ContainsKey(navItem) && expandedItems[navItem])
                {
                    <li class="sublinks-container">
                        <ul class="sublinks">
                            @foreach (NavLinkItem subLink in navItem.SubLinks)
                            {
                                <li class="sublink-item nav-item">
                                    <NavLink class="nav-link sublink" href="@subLink.Link" Match="NavLinkMatch.Prefix">
                                        @if (!string.IsNullOrEmpty(subLink.Icon))
                                        {
                                            <MudIcon Icon="@subLink.Icon" Title="@subLink.Title" />
                                        }
                                        @subLink.Title
                                    </NavLink>
                                </li>
                            }
                        </ul>
                    </li>
                }
            }
        </ul>
    </AuthorizeView>
    <div class="auth-controls">
        <AuthorizeView>
            <Authorized>
                <div style="display:grid; grid-template-columns: 1fr">
                    <i class="bi bi-search btn" href="authentication/profile" @onclick="OpenDialogAsync"></i>
                    <i class="bi bi-person-vcard btn" href="authentication/profile"></i>
                    <i class="bi bi-box-arrow-left btn" @onclick="BeginSignOut" />
                </div>
            </Authorized>
            <NotAuthorized>
                <NavLink class="nav-link" href="authentication/login">
                    <i class="bi bi-box-arrow-in-right btn" />
                </NavLink>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</nav>

@code {
    [Parameter]
    public required EventCallback NavToggled { get; set; }

    [Parameter]
    public required List<NavLinkItem> NavLinks { get; set; }

    [Parameter]
    public bool Minimize { get; set; }

    private Dictionary<NavLinkItem, bool> expandedItems = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    private void ToggleSubLinks(NavLinkItem navItem)
    {
        if (!expandedItems.ContainsKey(navItem))
        {
            expandedItems[navItem] = true;
        }
        else
        {
            expandedItems[navItem] = !expandedItems[navItem];
        }
        StateHasChanged();
    }

    private async Task MinimizeSidebar()
    {
        Minimize = !Minimize;
        await NavToggled.InvokeAsync();
    }

    private string width() => Minimize ? "width: 40px" : "width: 120px";


    private void BeginSignOut(MouseEventArgs args)
    {
        _navigationManager.NavigateToLogout("authentication/logout");
    }

    private Task OpenDialogAsync()
    {
        return _dialog.ShowAsync<SearchDialog>("", new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true });
    }
}