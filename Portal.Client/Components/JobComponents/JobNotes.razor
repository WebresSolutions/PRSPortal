@using Portal.Shared.DTO.Job

<Card ShowHeaderWithAddButton="true" HeaderTitle="Notes" OnAddButtonClick="OnAdd">
    <ChildContent>
        @if (Notes.Count is 0)
        {
            <div class="empty-state">No records</div>
        }
        else
        {
            @foreach (JobNoteDto note in Notes)
            {
                <div class="note-item" @onmouseover="@(() => editButtonToShow = note.NoteId)" @onmouseleave="@(() => editButtonToShow = 0)">
                    @if (editButtonToShow == note.NoteId)
                    {
                        <MudButton OnClick="@(async() => await OpenDialogAsync(note))" Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.RemoveRedEye" Class="view-button">View</MudButton>
                    }
                    <div class="note-content">
                        <div class="note-title">@((MarkupString)note.Content)</div>
                    </div>
                    <div class="note-meta">
                        <div class="note-date">@GetNoteDate(note)</div>
                        <div class="note-author">by @(note.AssignedUser?.displayName ?? "Unknown")</div>
                    </div>
                </div>
            }
        }
    </ChildContent>
</Card>

@code {
    [Parameter]
    public List<JobNoteDto> Notes { get; set; } = new();

    [Parameter]
    public EventCallback OnAdd { get; set; }

    private int editButtonToShow = 0;

    private string GetNoteDate(JobNoteDto note)
    {
        // Dummy date since JobNoteDto doesn't have a date field
        return note.DateCreated.ToString("dddd d-MMM-yyyy h:mmtt");
    }

    private async Task OpenDialogAsync(JobNoteDto note)
    {
        DialogParameters parameter = new DialogParameters<JobNoteDto> { { "Note", note } };
        DialogOptions options = new() { CloseButton = false, CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };

        IDialogReference _ = await _dialog.ShowAsync<EditJobNote>("", parameter, options);
    }
}

